---
title: "Monitor for diarrhea grade 3 or higher for protocol 15342"
geometry: margin=0.5cm
output:
  html_document: default
  pdf_document: default
  word_document: default
runtime: shiny
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r}
#libraries
library(dplyr)                  
library(reshape2)               
library(knitr)
library(kableExtra)
library(shiny)
library(DT)

#functions
source('./R/convert_date.R')    #function to convert to date type
source('./R/extract_col.R')     #function to extract columns
```
```{r echo=FALSE}

#upload csv files
inputPanel(
     fileInput('datafile', 'Choose CSV file',
                     multiple = TRUE,
                     accept=c('text/csv','text/comma-separated-values,text/plain',".csv"))
)

```

```{r}
    #reactive variable for uploaded csv files
    df <- reactive({
    req(input$datafile)
    
    
    #read all csv files uploaded
    files= lapply(input$datafile$datapath, read.csv,header=TRUE,stringsAsFactors=F,na.string="")
    
    #add names of element's list to respective supplied CSV files' names
    names(files)<-input$datafile$name
    
    #filter all elements of list by Active==1
    files_active = lapply(files,function(x) x[which(x$RecordActive==1),])

    files_active
   
  })
  #renderTable(df()$aelog.CSV) 
# #import desired csv file
# filename="aelog.CSV"  
# ae_data=read.csv(file = filename,header = T,stringsAsFactors = F,na.string="")
# 
# filename_subj = "subj.CSV"
 subject_data = reactive({df()$subj.CSV%>%rename_all(toupper)%>% select(SUBJECT,RPN)})# read.csv(file = filename_subj,header = T,stringsAsFactors = F,na.string="")

#renderDataTable(subject_data())subject = subject_data%>%rename_all(toupper)%>% select(SUBJECT,RPN)
total_subject = reactive({subject_data()%>%distinct(SUBJECT)%>%nrow})

#renderText(total_subject())
# #import desired csv file
# filename="aelog.CSV"  
 ae_data= reactive({df()$aelog.CSV})  # read.csv(file = filename,header = T,stringsAsFactors = F,na.string="")

#select desired columns
#desired_columns = c("Subject","MEDDRACODE","AESTARTDATE_RAW","AEGRADE","AEGRADE_STD","ATTRIBUTED1","InstanceName")
ae_clean = reactive({ae_data() %>% select(Subject,MEDDRACODE,AESTARTDATE_RAW,AEGRADE,AEGRADE_STD,ATTRIBUTED1,InstanceName) %>%mutate(MEDRACODE_CLEAN=gsub("[0-9-]",'',MEDDRACODE))})

#renderTable(ae_clean())
#remove the numbers 
#   ae_clean<-reactive({
# ae_clean()$MEDRACODE_CLEAN = gsub("[0-9-]",'',ae_clean()$MEDRACODE) })

#renderDataTable(ae_clean())

####################### Overall subjects in study ############################################
renderDataTable(DT::datatable( subject_data(),caption = "Total Subjects"))
#for pdf rendering
#kable(subject,format="latex",booktabs=T,row.names = FALSE)%>%kable_styling(position="center")
```
\begin{center}
There are `r  total_subject` patients accrued in the study
\end{center}

\newpage
```{r}
################# Report 1: Number of cases of diarrhea regardless of attribution and cycle (OVerall report diarrhea) ######################################
ae_sub = reactive({ae_clean()%>%select(Subject,AEGRADE,AESTARTDATE_RAW,MEDRACODE_CLEAN,InstanceName,ATTRIBUTED1)%>%rename("AE DATE"=AESTARTDATE_RAW,"Adverse Effect"=MEDRACODE_CLEAN)%>%mutate("AE DATE"=format(as.Date(convert_date(`AE DATE`)),"%m/%d/%y" ))})
#change column name
#ae_sub_new = rename(ae_sub,"AE DATE"=AESTARTDATE_RAW,"Adverse Effect"=MEDRACODE_CLEAN)
#change format of date
#ae_sub_new["AE DATE"] = format(as.Date(convert_date(ae_sub_new$`AE DATE`)),"%m/%d/%y" )
#renderTable(ae_sub())
#select diarrhea
ae_diarrhea = reactive({ae_sub() %>%mutate(`Adverse Effect`=tolower(`Adverse Effect`))%>% filter(`Adverse Effect`=="diarrhea")%>%rename("Cycle"=InstanceName,"ATTRIBUTION"=ATTRIBUTED1)%>%arrange(Subject)}) #ae_sub_new[which(tolower(ae_sub_new$`Adverse Effect`)=="diarrhea"),]
#renderTable(ae_diarrhea())
# ae_diarrhea_new = rename(ae_diarrhea,"Cycle"=InstanceName,"ATTRIBUTION"=ATTRIBUTED1)
# ae_diarrhea_ord = ae_diarrhea_new[order(ae_diarrhea_new$Subject),]

################# Report 2: Subjects highest AE grade within the first two cycles ############################################
#select subjects with diarrhea and grade greater or equal than 3
ae_diarrhea_cycle = reactive({ae_clean()%>%mutate(MEDRACODE_CLEAN=tolower(MEDRACODE_CLEAN),InstanceName=tolower(InstanceName))%>%filter(MEDRACODE_CLEAN=="diarrhea" & InstanceName %in% c("cycle 01","cycle 02"))   })#ae_clean[which(tolower(ae_clean$MEDRACODE_CLEAN)=="diarrhea" & (tolower(ae_clean$InstanceName)=="cycle 01" | tolower(ae_clean$InstanceName)=="cycle 02")),]

#renderTable({ae_diarrhea_cycle()})

#reorder columns and rename
ae_tablecycle_order = reactive({ae_diarrhea_cycle()%>%select(Subject,MEDRACODE_CLEAN,AEGRADE_STD,ATTRIBUTED1,AESTARTDATE_RAW,InstanceName)%>%rename("Adverse Effect"=MEDRACODE_CLEAN,"AE DATE"=AESTARTDATE_RAW,"AE GRADE"=AEGRADE_STD,"ATTRIBUTION"=ATTRIBUTED1,"Cycle"=InstanceName)  })#ae_diarrhea_cycle[c("Subject","MEDRACODE_CLEAN","AEGRADE_STD","ATTRIBUTED1","AESTARTDATE_RAW","InstanceName")]
# ae_tablecycle_new = rename(ae_tablecycle_order,"Adverse Effect"=MEDRACODE_CLEAN,"AE DATE"=AESTARTDATE_RAW,"AE GRADE"=AEGRADE_STD,"ATTRIBUTION"=ATTRIBUTED1,"Cycle"=InstanceName)

#highest ae grade for each subject
highest_grade_cycle = reactive({group_by(ae_tablecycle_order(),Subject)%>% mutate(`AE GRADE`=as.character(`AE GRADE`))%>% summarise("Highest AE grade within first two cycle"=max(`AE GRADE`)) })#aggregate(ae_tablecycle_new$`AE GRADE`,by=list(Subj=ae_tablecycle_new$Subject),max)

#change column's name
#names(highest_grade_cycle)<-c("Subject","Highest AE grade within first two cycle")
#renderTable(highest_grade_cycle())

# ################# Report 3: Subjects with grade >=3 diarrhea attributed to neratinib within first two cycle############################################
#select subjects with diarrhea and grade greater or equal than 3
ae_diarrhea_34 = ae_clean[which(tolower(ae_clean$MEDRACODE_CLEAN)=="diarrhea" & (ae_clean$AEGRADE_STD>=3)& (tolower(ae_clean$InstanceName)=="cycle 01" | tolower(ae_clean$InstanceName)=="cycle 02")),]

#reorder columns and rename
ae_table34_order = ae_diarrhea_34[c("Subject","MEDRACODE_CLEAN","AEGRADE","ATTRIBUTED1","AESTARTDATE_RAW","InstanceName")]
ae_table34_new = rename(ae_table34_order,"Adverse Effect"=MEDRACODE_CLEAN,"AE DATE"=AESTARTDATE_RAW,"AE GRADE"=AEGRADE,"ATTRIBUTION"="ATTRIBUTED1","Cycle"=InstanceName)

#change format of date
ae_table34_new["AE DATE"] = format(as.Date(convert_date(ae_table34_new$`AE DATE`)),"%m/%d/%y" )


################ Report 4: Number of cases of diarrhea by grade level within two first cycle ##########################################
ae_new = ae_sub_new[which(tolower(ae_sub_new$`Adverse Effect`)=="diarrhea"&(tolower(ae_clean$InstanceName)=="cycle 01" | tolower(ae_clean$InstanceName)=="cycle 02")),]
#remove duplicates
ae_diarrhea_order = ae_new[rev(order(ae_new$AEGRADE)),]
ae_diarrhea_nodup = ae_diarrhea_order[!duplicated(ae_diarrhea_order[c("Subject","AEGRADE")]),]
ae_diarrhea_nodup_new = ae_diarrhea_nodup[!duplicated(ae_diarrhea_nodup$Subject),]

####################################### STOP HERE ##############################
#convert to wide format
ae_diarrhea_table = dcast(ae_diarrhea_nodup_new,'Adverse Effect'~AEGRADE,fun.aggregate = length,value.var = "Adverse Effect")

#format table
ae_diarrhea_table[1,1]<-"Diarrhea"
renderDataTable( DT::datatable(ae_diarrhea,caption ="Table of patients who experienced diarrhea regardless of cycle"))
# For pdf rendering 
#kable(ae_diarrhea_ord,"latex",booktabs=T,longtable=TRUE,row.names = FALSE)%>%kable_styling(font_size=7,latex_options = "repeat_header")%>%add_footnote("Table of patients who experienced diarrhea regardless of cycle",notation="symbol")  
```   

####Summary: 
There are **`r length(unique(ae_diarrhea_ord$Subject))`** subjects who experienced diarrhea out of `r total_subject` subjects enrolled in the study. Patient **`r setdiff(unique(subject$Subject),unique(ae_diarrhea_ord$Subject))`** has not experienced diarrhea yet   
\newpage  
```{r}
count = length(which(highest_grade_cycle$`Highest AE grade within first two cycle`>=3))

renderDataTable(DT::datatable( highest_grade_cycle,caption ="Table of highest AE grade for subjects who experienced diarrhea within the first two cycles" ))

#for pdf rendering 
#kable(highest_grade_cycle,"latex",booktabs=T,row.names = FALSE)%>%kable_styling(font_size=8)%>%add_footnote("Table of highest AE grade for subjects who experienced diarrhea within the first two cycles",notation="symbol")
```

####Summary:  
There are **`r count`** subjects out of **`r length(unique(highest_grade_cycle$Subject))`** who experienced diarrhea grade 3 or higher within the first two cycles 
\newline
\newline
\newline
\newline
```{r}
renderTable(ae_table34_new) 

#for pdf rendering 
#kable(ae_table34_new,"latex",booktabs=T,row.names = FALSE)%>%kable_styling(font_size=8)%>%add_footnote("Table of patients who experienced diarrhea grade 3 or higher within two cycles",notation="symbol")

renderTable(ae_diarrhea_table)
#for pdf rendering
# kable(ae_diarrhea_table,"latex",booktabs=T,row.names = FALSE)%>%kable_styling(font_size=8)%>%add_footnote("Number of subjects who experienced diarrhea within the first two cycle by AE grade")

```










